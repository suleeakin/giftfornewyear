<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi</title> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 90%; max-width: 450px; text-align: center; }
        h1 { color: #d9534f; margin-bottom: 25px; font-size: 1.8em; }
        select, button { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; font-size: 1em; }
        select { border: 1px solid #ccc; background-color: #fafafa; }
        button { background-color: #5cb85c; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #4cae4c; }
        #result { margin-top: 25px; padding: 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; background-color: #e6e6e6; color: #333; min-height: 30px; }
        .info { font-size: 0.9em; color: #777; margin-top: 15px; }
        /* Konfeti gÃ¶rsel efekti iÃ§in animasyon */
        @keyframes confetti-burst { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .confetti { animation: confetti-burst 0.5s ease-out; }
    </style>
</head>
<body>
    <div class="container">
        <h1>YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi ğŸ</h1>
        <select id="participantSelect" aria-label="LÃ¼tfen listeden kendi adÄ±nÄ±zÄ± seÃ§iniz."></select>
        <button id="drawButton">Kime Hediye AlacaÄŸÄ±m?</button>
        <div id="result">LÃ¼tfen listeden kendi adÄ±nÄ±zÄ± seÃ§iniz.</div>
        <div class="info">Sonucunuz sadece size Ã¶zeldir ve tarayÄ±cÄ±nÄ±zda saklanÄ±r.</div>
    </div>

    <script>
        // KRÄ°TÄ°K: EKSÄ°KSÄ°Z VE DOÄRU FIREBASE KONFÄ°GÃœRASYONU (Sizin Projenize ait)
        const firebaseConfig = {
          apiKey: "AiZaSyACw0EuiKei-JPDnJcRXLWw-J9ntXoSFÄ°", 
          authDomain: "newyeargift-2ae9a.firebaseapp.com",
          projectId: "newyeargift-2ae9a",
          storageBucket: "newyeargift-2ae9a.appspot.com",
          messagingSenderId: "21487043286",
          appId: "1:21487043286:web:4ea67e4b27463c5b49ff77",
          measurementId: "G-58TDFPD5MH",
          databaseURL: "https://newyeargift-2ae9a-default-rtdb.europe-west1.firebaseapp.app" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const participantsRef = database.ref('katilimcilar');
        
        const selectElement = document.getElementById('participantSelect');
        const drawButton = document.getElementById('drawButton');
        const resultDiv = document.getElementById('result');
        
        const selfName = localStorage.getItem('selfName');
        const assignedGift = localStorage.getItem('assignedGift');

        function launchConfettiVisual() {
            resultDiv.classList.add('confetti');
            setTimeout(() => {
                resultDiv.classList.remove('confetti');
            }, 500);
            
            resultDiv.style.backgroundColor = '#dff0d8'; 
            resultDiv.style.color = '#3c763d';
        }
        
        // Ã‡ekiliÅŸi Yapar (TÃ¼m kurallarÄ± iÃ§erir)
        async function makeDraw() {
            const selectedName = selectElement.value;
            if (!selectedName || selectedName === 'default') {
                resultDiv.textContent = 'LÃ¼tfen listeden kendi adÄ±nÄ±zÄ± seÃ§iniz.';
                return;
            }
        
            drawButton.disabled = true;
            resultDiv.textContent = 'ÅanslÄ± ismi Ã§ekiyoruz... LÃ¼tfen bekleyin.';
        
            try {
                const snapshot = await participantsRef.once('value');
                const allParticipants = snapshot.val();
            
                // AlÄ±cÄ± listesi oluÅŸturulur: Kendi adÄ± olmayan ve daha Ã¶nce alÄ±cÄ± olarak atanmamÄ±ÅŸ ('Musait' olan) kiÅŸiler.
                const availableRecipients = Object.keys(allParticipants).filter(name => {
                    // 1. Kural: Kendini Ã§ekememe
                    if (name === selectedName) return false;
                    // 2. Kural: Daha Ã¶nce alÄ±cÄ± olarak atanmamÄ±ÅŸ olma
                    if (allParticipants[name] === 'Musait') return true;

                    return false;
                });
            
                if (availableRecipients.length === 0) {
                    resultDiv.textContent = 'Ã‡ekiliÅŸ yapÄ±lacak mÃ¼sait kiÅŸi kalmadÄ±.';
                    drawButton.disabled = false;
                    return;
                }
            
                // Rastgele bir alÄ±cÄ± seÃ§
                const randomIndex = Math.floor(Math.random() * availableRecipients.length);
                const recipientName = availableRecipients[randomIndex];
            
                // Firebase'de gÃ¼ncelleme:
                // 1. Ã‡ekiliÅŸi yapan kiÅŸinin (selectedName) kime hediye alacaÄŸÄ± bilgisini kaydet.
                await participantsRef.child(selectedName).set(recipientName);

                // 2. AlÄ±cÄ±nÄ±n (recipientName) durumunu 'Assigned' olarak gÃ¼ncelle ki bir daha Ã§ekilmesin (Ã‡ekilen bir daha Ã§ekilemez kuralÄ±)
                await participantsRef.child(recipientName).set('Assigned');
                
                // Sonucu Local Storage'a kaydet (Gizlilik ve Bir Kere GÃ¶rme KuralÄ±)
                localStorage.setItem('selfName', selectedName);
                localStorage.setItem('assignedGift', recipientName);
            
                // Sonucu gÃ¶ster
                showResult(selectedName, recipientName);
            
            } catch (error) {
                resultDiv.textContent = 'Hata oluÅŸtu, tekrar deneyin: VeritabanÄ± baÄŸlantÄ±sÄ± veya kural hatasÄ± olabilir.';
                console.error("Ã‡ekiliÅŸ sÄ±rasÄ±nda hata:", error);
                drawButton.disabled = false;
            }
        }
        
        function showResult(self, recipient) {
            resultDiv.innerHTML = `ğŸ‰ğŸ‰ğŸ‰ Tebrikler! Hediyeyi alacaÄŸÄ±nÄ±z kiÅŸi: **${recipient}** ğŸ‰ğŸ‰ğŸ‰`;
            drawButton.textContent = 'Ã‡ekiliÅŸ YapÄ±ldÄ±!';
            drawButton.disabled = true;
            launchConfettiVisual();
        }
        
        async function loadApp() {
            // SeÃ§enekleri yÃ¼kle
            participantsRef.once('value', (snapshot) => {
                const allParticipants = snapshot.val();
                selectElement.innerHTML = '<option value="default">Kendi AdÄ±nÄ±zÄ± SeÃ§iniz</option>'; 
                if (allParticipants) {
                    Object.keys(allParticipants).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    });
                }
            });
        
            // Daha Ã¶nce Ã§ekiliÅŸ yapÄ±lÄ±p yapÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
            if (selfName && assignedGift) {
                selectElement.value = selfName;
                showResult(selfName, assignedGift);
            } else {
                drawButton.disabled = false;
                drawButton.textContent = 'Kime Hediye AlacaÄŸÄ±m?'; 
            }
        
            drawButton.addEventListener('click', makeDraw);
        }
        
        loadApp();
    </script>
</body>
</html>